input {
  http {
    port => 8080
    codec => json
  }
}

filter {
  # Добавляем timestamp если его нет
  if ![timestamp] {
    mutate {
      add_field => { "timestamp" => "%{@timestamp}" }
    }
  }
  
  # Базовое обогащение по типу IoC
  if [type] == "ip" {
    # GeoIP обогащение
    geoip {
      source => "value"
      target => "geoip"
    }
    
    # Проверка приватных IP
    cidr {
      address => [ "%{value}" ]
      network => [ "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16" ]
      add_field => { "is_private" => "true" }
    }
  }
  
  if [type] == "domain" {
    # DNS lookup
    dns {
      resolve => ["value"]
      action => "append"
      nameserver => ["8.8.8.8"]
    }
  }
  
  # Расчет severity
  ruby {
    code => '
      confidence = event.get("confidence").to_i
      if confidence >= 90
        event.set("severity", "critical")
      elsif confidence >= 70
        event.set("severity", "high")
      elsif confidence >= 50
        event.set("severity", "medium")
      else
        event.set("severity", "low")
      end
    '
  }
  
  # Добавляем метаданные
  mutate {
    add_field => {
      "enriched_at" => "%{@timestamp}"
      "[@metadata][index]" => "ioc-%{+YYYY.MM.dd}"
    }
  }
}

output {
  # OpenSearch
  opensearch {
    hosts => ["https://localhost:9200"]
    index => "%{[@metadata][index]}"
    user => "admin"
    password => "admin"
    ssl_certificate_verification => false
  }
  
  # Дебаг вывод
  stdout {
    codec => rubydebug
  }
}
